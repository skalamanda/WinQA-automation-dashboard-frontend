<div class="jenkins-results-container">
    <!-- Success Toast Message -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div class="toast show" [class.d-none]="!showSuccessMessage" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" (click)="showSuccessMessage = false"></button>
            </div>
            <div class="toast-body">
                {{ successMessage }}
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="card header-card">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="card-title">
                            <i class="fab fa-jenkins me-2"></i>
                            Jenkins Test Results
                        </h2>
                        <p class="card-text text-muted">
                            Monitor your Jenkins CI/CD pipeline test results and build status
                        </p>
                    </div>
                    <div class="header-controls">
                        <div class="connection-status me-3">
                            <span class="badge" [class]="connectionStatus ? 'bg-success' : 'bg-danger'">
                                <i class="fas" [class.fa-check-circle]="connectionStatus" [class.fa-exclamation-triangle]="!connectionStatus"></i>
                                {{ connectionStatus ? 'Connected' : 'Disconnected' }}
                            </span>
                        </div>
                        <button
                                class="btn btn-primary me-2"
                                (click)="syncAllJobs()"
                                [disabled]="syncing || !connectionStatus"
                        >
                            <span *ngIf="syncing" class="spinner-border spinner-border-sm me-2"></span>
                            <i class="fas fa-sync-alt me-2" *ngIf="!syncing"></i>
                            {{ syncing ? 'Syncing...' : 'Sync All Jobs' }}
                        </button>
                        <button class="btn btn-outline-secondary" (click)="testConnection()">
                            <i class="fas fa-plug me-2"></i>
                            Test Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mt-4">
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fab fa-jenkins stats-icon text-primary"></i>
                    <h3 class="mt-2">{{ jenkinsStats.totalJobs }}</h3>
                    <p class="text-muted">Total Jobs</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle stats-icon text-success"></i>
                    <h3 class="mt-2">{{ jenkinsStats.successfulJobs }}</h3>
                    <p class="text-muted">Successful</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle stats-icon text-danger"></i>
                    <h3 class="mt-2">{{ jenkinsStats.failedJobs }}</h3>
                    <p class="text-muted">Failed</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-vials stats-icon text-info"></i>
                    <h3 class="mt-2">{{ jenkinsStats.totalTests }}</h3>
                    <p class="text-muted">Total Tests</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-check stats-icon text-success"></i>
                    <h3 class="mt-2">{{ jenkinsStats.passedTests }}</h3>
                    <p class="text-muted">Passed</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-times stats-icon text-danger"></i>
                    <h3 class="mt-2">{{ jenkinsStats.failedTests }}</h3>
                    <p class="text-muted">Failed</p>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Enhanced Filter Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card filter-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Advanced Filters
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Project</label>
                            <select
                                    class="form-select"
                                    [(ngModel)]="selectedProjectId"
                                    (change)="onProjectFilterChange()"
                            >
                                <option [ngValue]="null">All Projects</option>
                                <option *ngFor="let project of projects" [ngValue]="project.id">
                                    {{ project.name }}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Automation Tester</label>
                            <select
                                    class="form-select"
                                    [(ngModel)]="selectedAutomationTesterId"
                                    (change)="onAutomationTesterFilterChange()"
                            >
                                <option [ngValue]="null">All Testers</option>
                                <option *ngFor="let tester of automationTesters" [ngValue]="tester.id">
                                    {{ tester.name }}
                                </option>
                            </select>
                        </div>
<!--                        <div class="col-md-3">-->
<!--                            <label class="form-label">Job Frequency</label>-->
<!--                            <select-->
<!--                                    class="form-select"-->
<!--                                    [(ngModel)]="selectedJobFrequency"-->
<!--                                    (change)="onJobFrequencyFilterChange()"-->
<!--                            >-->
<!--                                <option *ngFor="let freq of jobFrequencyOptions" [value]="freq.value">-->
<!--                                    {{ freq.label }}-->
<!--                                </option>-->
<!--                            </select>-->
<!--                        </div>-->
                        <div class="col-md-3">
                            <label class="form-label">Pass Threshold %</label>
                            <div class="input-group">
                                <select 
                                    class="form-select"
                                    [(ngModel)]="passPercentageOperator"
                                    (change)="applyFilters()"
                                    style="max-width: 80px; border-radius: 25px 0 0 25px;"
                                >
                                    <option value="gte">≥</option>
                                    <option value="lte">≤</option>
                                </select>
                                <input
                                        type="number"
                                        class="form-control"
                                        placeholder="Pass %"
                                        [(ngModel)]="passPercentageThreshold"
                                        (input)="applyFilters()"
                                        min="0"
                                        max="100"
                                        style="border-radius: 0 25px 25px 0;"
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row mt-4">
        <!-- Jobs Table -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Jenkins Jobs ({{ filteredResults.length }})
                        </h5>
                        <div class="filter-controls d-flex gap-3">
                            <div class="search-box">
                                <div class="position-relative">
                                    <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            placeholder="Search jobs..."
                                            [(ngModel)]="searchTerm"
                                            (input)="onSearchChange()"
                                    >
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                            </div>
                            <select
                                    class="form-select form-select-sm"
                                    [(ngModel)]="selectedStatus"
                                    (change)="onStatusFilterChange()"
                            >
                                <option *ngFor="let status of statusOptions" [value]="status.value">
                                    {{ status.label }}
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-scrollable">
                    <table class="table table-hover mb-0" *ngIf="filteredResults.length > 0; else noJobs">
                        <thead>
                        <tr>
                            <th (click)="sortTable('jobName')" [class.sorted]="isSorted('jobName')" class="sortable">
                                Job Name <i [class]="getSortIcon('jobName')"></i>
                            </th>
                            <th (click)="sortTable('buildNumber')" [class.sorted]="isSorted('buildNumber')" class="sortable">
                                Build <i [class]="getSortIcon('buildNumber')"></i>
                            </th>
                            <th (click)="sortTable('buildStatus')" [class.sorted]="isSorted('buildStatus')" class="sortable">
                                Status <i [class]="getSortIcon('buildStatus')"></i>
                            </th>
                            <th class="text-center">Tests</th>
                            <th class="text-center">Pass %</th>
                            <!-- NEW: Project column -->
                            <th>Project</th>
                            <!-- NEW: Job Frequency column -->
                            <th>Schedule</th>
                            <th (click)="sortTable('buildTimestamp')" [class.sorted]="isSorted('buildTimestamp')" class="sortable">
                                Build Time <i [class]="getSortIcon('buildTimestamp')"></i>
                            </th>
                            <th class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr
                                *ngFor="let result of filteredResults"
                                [class.table-active]="selectedJob?.id === result.id"
                                class="job-row"
                        >
                            <td class="job-name">
                                <strong>{{ result.jobName }}</strong>
                            </td>
                            <td>
                                <a [href]="result.buildUrl" target="_blank" class="text-decoration-none">
                                    #{{ result.buildNumber }}
                                    <i class="fas fa-external-link-alt ms-1 small"></i>
                                </a>
                            </td>
                            <td>
                                <span class="badge" [class]="getBuildStatusColor(result.buildStatus)">
                                    {{ result.buildStatus }}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="test-summary">
                                    <span class="badge bg-success me-1" *ngIf="result.passedTests">
                                        ✓ {{ result.passedTests }}
                                    </span>
                                    <span class="badge bg-danger me-1" *ngIf="result.failedTests">
                                        ✗ {{ result.failedTests }}
                                    </span>
                                    <span class="badge bg-warning" *ngIf="result.skippedTests">
                                        ⊘ {{ result.skippedTests }}
                                    </span>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge" [ngClass]="{
                                    'bg-success': getPassPercentage(result) >= 80,
                                    'bg-warning': getPassPercentage(result) < 80 && getPassPercentage(result) >= 50,
                                    'bg-danger': getPassPercentage(result) < 50
                                }">
                                    {{ getPassPercentage(result) }}%
                                </span>
                            </td>
                            <!-- NEW: Project display -->
                            <td>
                                <small class="text-muted">
                                    <i class="fas fa-project-diagram me-1"></i>
                                    {{ getProjectName(result) }}
                                </small>
                            </td>
                            <!-- NEW: Job frequency display -->
                            <td>
                                <span class="badge bg-secondary">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ getJobFrequencyDisplay(result) }}
                                </span>
                            </td>
                            <td>
                                <small>{{ result.buildTimestamp | date:'short' }}</small>
                            </td>
                            <td class="text-center">
                                <button
                                        class="btn btn-outline-primary btn-sm me-1"
                                        (click)="selectJob(result)"
                                        [class.active]="selectedJob?.id === result.id"
                                >
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button
                                        class="btn btn-outline-secondary btn-sm"
                                        (click)="syncSingleJob(result.jobName)"
                                        title="Sync this job"
                                >
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <ng-template #noJobs>
                        <div class="no-data">
                            <i class="fab fa-jenkins text-muted"></i>
                            <h5 class="mt-3 text-muted">No Jenkins jobs found</h5>
                            <p class="text-muted">
                                {{ searchTerm ? 'No jobs match your search criteria' : 'Click "Sync All Jobs" to fetch data from Jenkins' }}
                            </p>
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="col-lg-4">
            <div class="card chart-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Test Results Overview
                    </h5>
                    <button
                            *ngIf="selectedJob"
                            class="btn btn-outline-secondary btn-sm"
                            (click)="clearSelection()"
                    >
                        <i class="fas fa-times me-1"></i> Clear Selection
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container" *ngIf="!selectedJob">
                        <canvas id="overallChart"></canvas>
                    </div>
                    <div class="chart-container" *ngIf="selectedJob">
                        <canvas id="jobChart"></canvas>
                    </div>
                    <div class="mt-3" *ngIf="!jenkinsResults.length && !loading">
                        <p class="text-muted text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            No data available for charts
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ENHANCED: Project, Testers, and Notes Section with Single Save Button -->
    <div class="row mt-4" *ngIf="selectedJob">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                Job Configuration - {{ selectedJob.jobName }} (Build #{{ selectedJob.buildNumber }})
                            </h5>
                        </div>
                        <!-- ENHANCED: Single Save Button -->
                        <button
                                class="btn btn-success"
                                (click)="saveAllData()"
                                [disabled]="saveButtonDisabled || isSaving"
                        >
                            <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                            <i class="fas fa-save me-1" *ngIf="!isSaving"></i>
                            {{ isSaving ? 'Saving...' : 'Save All Changes' }}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Project, Testers, and Metrics in one row -->
                    <div class="row g-3 mb-4">
                        <!-- Project Assignment -->
                        <div class="col-md-3">
                            <label class="form-label">
                                <i class="fas fa-project-diagram me-1"></i>
                                Project Assignment
                            </label>
                            <div *ngIf="selectedJob.project && !projectSelection[selectedJob.id]; else projectSel">
                                <div class="alert alert-info mb-0 py-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ displayProject(selectedJob.project) }}
                                </div>
                            </div>
                            <ng-template #projectSel>
                                <select
                                        class="form-select"
                                        [(ngModel)]="projectSelection[selectedJob.id]"
                                        (change)="onProjectSelectionChange()"
                                >
                                    <option [ngValue]="null">Select Project</option>
                                    <option *ngFor="let project of projects" [ngValue]="project.id">
                                        {{ project.name }}
                                    </option>
                                </select>
                            </ng-template>
                        </div>

                        <!-- Automation Tester -->
                        <div class="col-md-3">
                            <label class="form-label">
                                <i class="fas fa-robot me-1"></i>
                                Automation Tester
                            </label>
                            <div *ngIf="selectedJob.automationTester && !automationTesterSelection[selectedJob.id]; else autoSel">
                                <div class="alert alert-success mb-0 py-2">
                                    <i class="fas fa-user-check me-1"></i>
                                    {{ displayTester(selectedJob.automationTester) }}
                                </div>
                            </div>
                            <ng-template #autoSel>
                                <select
                                        class="form-select"
                                        [(ngModel)]="automationTesterSelection[selectedJob.id]"
                                        (change)="onTesterSelectionChange()"
                                >
                                    <option [ngValue]="null">Select Automation Tester</option>
                                    <option *ngFor="let tester of testers" [ngValue]="tester.id">
                                        {{ tester.name }}
                                    </option>
                                </select>
                            </ng-template>
                        </div>

                        <!-- Manual Tester -->
                        <div class="col-md-3">
                            <label class="form-label">
                                <i class="fas fa-user me-1"></i>
                                Manual Tester
                            </label>
                            <div *ngIf="selectedJob.manualTester && !manualTesterSelection[selectedJob.id]; else manualSel">
                                <div class="alert alert-warning mb-0 py-2">
                                    <i class="fas fa-user-check me-1"></i>
                                    {{ displayTester(selectedJob.manualTester) }}
                                </div>
                            </div>
                            <ng-template #manualSel>
                                <select
                                        class="form-select"
                                        [(ngModel)]="manualTesterSelection[selectedJob.id]"
                                        (change)="onTesterSelectionChange()"
                                >
                                    <option [ngValue]="null">Select Manual Tester</option>
                                    <option *ngFor="let tester of testers" [ngValue]="tester.id">
                                        {{ tester.name }}
                                    </option>
                                </select>
                            </ng-template>
                        </div>

                        <!-- Pass Percentage & Job Schedule -->
                        <div class="col-md-3">
                            <label class="form-label">
                                <i class="fas fa-chart-line me-1"></i>
                                Metrics & Schedule
                            </label>
                            <div class="d-flex flex-column gap-2">
                                <span class="badge fs-6" [ngClass]="{
                                    'bg-success': getPassPercentage(selectedJob) >= 80,
                                    'bg-warning': getPassPercentage(selectedJob) < 80 && getPassPercentage(selectedJob) >= 50,
                                    'bg-danger': getPassPercentage(selectedJob) < 50
                                }">
                                    Pass Rate: {{ getPassPercentage(selectedJob) }}%
                                </span>
                                <span class="badge bg-secondary fs-6">
                                    <i class="fas fa-clock me-1"></i>
                                    Schedule: {{ getJobFrequencyDisplay(selectedJob) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">
                                <i class="fas fa-bug me-1"></i>
                                Bugs Identified / Failure Reasons
                            </label>
                            <textarea
                                    class="form-control"
                                    rows="3"
                                    [(ngModel)]="jobNotes"
                                    (input)="onNotesChange()"
                                    placeholder="Enter details about bugs identified, failure reasons, or any observations about this build..."
                            ></textarea>
                            <small class="form-text text-muted mt-1">
                                <i class="fas fa-info-circle me-1"></i>
                                Describe any bugs found, failure reasons, or insights to help with debugging and future test runs.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Cases Detail Section with Stack Trace Enhancement -->
    <div class="row mt-4" *ngIf="selectedJob">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="fas fa-vial me-2"></i>
                                Test Cases - {{ selectedJob.jobName }} (Build #{{ selectedJob.buildNumber }})
                            </h5>
                            <small class="text-muted">
                                Total: {{ filteredTestCases.length }} |
                                Passed: {{ getPassedTestCasesCount() }} |
                                Failed: {{ getFailedTestCasesCount() }} |
                                Skipped: {{ getSkippedTestCasesCount() }}
                            </small>
                        </div>
                        <div class="test-case-controls d-flex gap-3">
                            <div class="search-box">
                                <div class="position-relative">
                                    <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            placeholder="Search test cases..."
                                            [(ngModel)]="testCaseSearchTerm"
                                            (input)="onTestCaseSearchChange()"
                                    >
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                            </div>
                            <select
                                    class="form-select form-select-sm"
                                    [(ngModel)]="selectedTestCaseStatus"
                                    (change)="onTestCaseStatusFilterChange()"
                            >
                                <option *ngFor="let status of testCaseStatusOptions" [value]="status.value">
                                    {{ status.label }}
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-scrollable test-cases-table">
                    <table class="table table-sm mb-0" *ngIf="filteredTestCases.length > 0; else noTestCases">
                        <thead>
                        <tr>
                            <th (click)="sortTestCases('status')" [class.sorted]="isTestCaseSorted('status')" class="sortable">
                                Status <i [class]="getTestCaseSortIcon('status')"></i>
                            </th>
                            <th (click)="sortTestCases('testName')" [class.sorted]="isTestCaseSorted('testName')" class="sortable">
                                Test Name <i [class]="getTestCaseSortIcon('testName')"></i>
                            </th>
                            <th (click)="sortTestCases('className')" [class.sorted]="isTestCaseSorted('className')" class="sortable">
                                Class <i [class]="getTestCaseSortIcon('className')"></i>
                            </th>
                            <th (click)="sortTestCases('duration')" [class.sorted]="isTestCaseSorted('duration')" class="sortable">
                                Duration <i [class]="getTestCaseSortIcon('duration')"></i>
                            </th>
                            <!-- ENHANCEMENT: New column for failure reason -->
                            <th class="text-center">Failure Details</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let testCase of filteredTestCases" [class]="getTestStatusColor(testCase.status)">
                            <td class="text-center">
                                <i [class]="getTestStatusIcon(testCase.status)" [class]="getTestStatusColor(testCase.status)"></i>
                                <span class="ms-1">{{ testCase.status }}</span>
                            </td>
                            <td>
                                <code class="test-name">{{ testCase.testName }}</code>
                            </td>
                            <td>
                                <small class="text-muted">{{ testCase.className }}</small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ formatDuration(testCase.duration) }}</span>
                            </td>
                            <!-- ENHANCEMENT: Stack trace and failure reason display -->
                            <td class="text-center">
                                <div *ngIf="testCase.status === 'FAILED'">
                                    <!-- Show failure reason -->
                                    <div class="mb-1">
                                        <small class="text-danger">
                                            {{ getFailureReason(testCase) }}
                                        </small>
                                    </div>
                                    <!-- Stack trace button to open modal -->
                                    <button
                                            *ngIf="hasStackTrace(testCase)"
                                            class="btn btn-outline-danger btn-sm"
                                            (click)="showFullStackTrace(testCase)"
                                            title="Click to view full stack trace"
                                    >
                                        <i class="fas fa-bug"></i> View Stack Trace
                                    </button>
                                    <small *ngIf="!hasStackTrace(testCase)" class="text-muted">
                                        No stack trace available
                                    </small>
                                </div>
                                <span *ngIf="testCase.status !== 'FAILED'" class="text-muted">-</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <ng-template #noTestCases>
                        <div class="no-data">
                            <i class="fas fa-flask text-muted"></i>
                            <h5 class="mt-3 text-muted">No test cases found</h5>
                            <p class="text-muted">
                                {{ testCaseSearchTerm || selectedTestCaseStatus ? 'No test cases match your search criteria' : 'This build may not have detailed test results available.' }}
                            </p>
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="loading">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading Jenkins data...</p>
        </div>
    </div>

    <!-- TestNG Report Modal -->
    <div class="modal-overlay" *ngIf="showReport" (click)="closeReport()">
        <div class="modal-content testng-report-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-chart-bar me-2"></i>
                    TestNG Comprehensive Report
                </h2>
                <button type="button" class="close-btn" (click)="closeReport()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body" *ngIf="testngReport">
                <!-- Summary Statistics -->
                <div class="report-summary mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="summary-value">{{ testngReport.totalJobs }}</div>
                                <div class="summary-label">Total Jobs</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="summary-value text-success">{{ testngReport.summary?.totalPassed || 0 }}</div>
                                <div class="summary-label">Total Passed</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="summary-value text-danger">{{ testngReport.summary?.totalFailed || 0 }}</div>
                                <div class="summary-label">Total Failed</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="summary-value text-warning">{{ testngReport.summary?.totalSkipped || 0 }}</div>
                                <div class="summary-label">Total Skipped</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Job Details Table -->
                <div class="report-table">
                    <h5>Job Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Job Name</th>
                                <th>Build</th>
                                <th>Status</th>
                                <th class="text-center">Total Tests</th>
                                <th class="text-center">Passed</th>
                                <th class="text-center">Failed</th>
                                <th class="text-center">Skipped</th>
                                <th>Execution Date</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr *ngFor="let job of testngReport.jobReports">
                                <td><strong>{{ job.jobName }}</strong></td>
                                <td>
                                    <span class="badge bg-secondary">#{{ job.buildNumber }}</span>
                                </td>
                                <td>
                    <span class="badge" [class]="getBuildStatusColor(job.buildStatus)">
                      {{ job.buildStatus }}
                    </span>
                                </td>
                                <td class="text-center">{{ job.totalTestCases }}</td>
                                <td class="text-center">
                                    <span class="badge bg-success" *ngIf="job.passCount !== 'N/A'">{{ job.passCount }}</span>
                                    <span *ngIf="job.passCount === 'N/A'">N/A</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-danger" *ngIf="job.failCount !== 'N/A'">{{ job.failCount }}</span>
                                    <span *ngIf="job.failCount === 'N/A'">N/A</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning" *ngIf="job.skipCount !== 'N/A'">{{ job.skipCount }}</span>
                                    <span *ngIf="job.skipCount === 'N/A'">N/A</span>
                                </td>
                                <td>
                                    <small>{{ job.executionDate | date:'short' }}</small>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Generation Info -->
                <div class="report-footer mt-4">
                    <div class="text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        Report generated at: {{ testngReport.generatedAt | date:'medium' }}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="closeReport()">
                    <i class="fas fa-times me-2"></i>
                    Close
                </button>
                <button class="btn btn-primary" (click)="generateTestNGReport()" [disabled]="generating">
                    <i class="fas fa-sync-alt me-2"></i>
                    Refresh Report
                </button>
            </div>
        </div>
    </div>

    <!-- Stack Trace Modal -->
    <div class="modal-overlay" *ngIf="showStackTraceModal" (click)="closeStackTraceModal()">
        <div class="modal-content stack-trace-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-bug me-2"></i>
                    Stack Trace - {{ selectedTestCaseName }}
                </h2>
                <button type="button" class="close-btn" (click)="closeStackTraceModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="stack-trace-container">
                    <pre class="stack-trace-content">{{ selectedStackTrace }}</pre>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="closeStackTraceModal()">
                    <i class="fas fa-times me-2"></i>
                    Close
                </button>
                <button class="btn btn-primary" (click)="copyStackTrace()">
                    <i class="fas fa-copy me-2"></i>
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Additional CSS for enhanced features -->
<style>
    .toast-container .toast {
        min-width: 300px;
    }

    .test-cases-table .btn-outline-danger:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .tooltip {
        z-index: 1070;
    }

    .tooltip-inner {
        max-width: 400px;
        text-align: left;
        font-size: 0.875rem;
        background-color: #343a40;
    }

    .save-button-container {
        position: sticky;
        top: 0;
        z-index: 1020;
        background: white;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .form-control:focus, .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .table-active {
        background-color: rgba(0, 123, 255, 0.1) !important;
    }

    /* Stack trace button styling */
    .btn-outline-danger.btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    /* Enhanced tooltip styling for stack traces */
    [data-bs-toggle="tooltip"] {
        cursor: help;
    }

    /* Success message styling */
    .toast.show {
        opacity: 1;
        animation: slideInRight 0.3s ease-in-out;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Enhanced pass percentage badges */
    .badge.bg-success {
        background-color: #28a745 !important;
    }

    .badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }

    .badge.bg-danger {
        background-color: #dc3545 !important;
    }

    /* Improved form controls */
    .form-select, .form-control {
        transition: all 0.15s ease-in-out;
    }

    .form-select:hover, .form-control:hover {
        border-color: #adb5bd;
    }

    /* Save button enhancement */
    .btn-success:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-success:not(:disabled):hover {
        background-color: #218838;
        border-color: #1e7e34;
    }

    /* Test case failure details */
    .text-danger {
        font-weight: 500;
    }

    /* Stack Trace Modal Styles */
    .stack-trace-modal {
        width: 1000px;
        max-width: 95vw;
        max-height: 90vh;
    }

    .stack-trace-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0;
        max-height: 60vh;
        overflow: auto;
    }

    .stack-trace-content {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        margin: 0;
        font-family: 'Courier New', Consolas, monospace;
        font-size: 0.875rem;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
        border-radius: 8px;
        max-height: none;
        overflow: visible;
    }

    .stack-trace-content::-webkit-scrollbar {
        width: 8px;
    }

    .stack-trace-content::-webkit-scrollbar-track {
        background: #4a5568;
        border-radius: 4px;
    }

    .stack-trace-content::-webkit-scrollbar-thumb {
        background: #718096;
        border-radius: 4px;
    }

    .stack-trace-content::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    /* Enhanced input group styling */
    .input-group .form-select {
        border-right: none;
    }

    .input-group .form-control {
        border-left: none;
    }

    .input-group .form-select:focus {
        box-shadow: none;
        border-color: #667eea;
    }

    .input-group .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        border-color: #667eea;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .filter-controls {
            flex-direction: column;
            gap: 10px !important;
        }

        .header-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .test-case-controls {
            flex-direction: column;
            gap: 10px !important;
        }

        .stack-trace-modal {
            width: 100%;
            max-width: 100%;
        }

        .stack-trace-content {
            font-size: 0.75rem;
            padding: 15px;
        }
    }
</style>